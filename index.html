<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KFUPM Faculty Evaluation Verifier (Multi-Sheet)</title>
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:20px;background:#f7fafc;color:#0f172a}
    h1{font-size:22px;margin-bottom:6px}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input[type=file]{padding:8px}
    button{background:#0ea5a4;border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer}
    button.secondary{background:#64748b}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #e6eef6;text-align:left;font-size:13px}
    tr.match{background:#f0fdf4}
    tr.mismatch{background:#fff7f0}
    .small{font-size:12px;color:#475569}
    .footer{margin-top:18px;text-align:center;color:#94a3b8}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:600}
    .green{background:#dcfce7;color:#065f46}
    .red{background:#fff1f2;color:#7f1d1d}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .flexright{margin-left:auto}
    .diff{font-weight:600}
    .export{background:#2563eb}
    .note{background:#f1f5f9;padding:10px;border-radius:8px;color:#0f172a}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>KFUPM Faculty Evaluation Verifier (Multi-Sheet)</h1>
  <p class="small">Upload the <strong>Faculty Evaluation Analysis</strong> file and the two verification files from the system. The tool will automatically process these main sheets: <strong>All Faculty, CHM, CEP, CCM, CDB, CPG, KBS, CGS, PREP YEAR, DCC</strong>. It will use <strong>KFUPM ID</strong> as the key and <strong>Rank</strong> to determine which verification file to use.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>Main file (Faculty Evaluation Analysis)<br><input id="fileMain" type="file" accept=".xlsx,.xls,.csv" /></label>
      </div>
      <div>
        <label>Faculty Professorial (verification)<br><input id="fileProf" type="file" accept=".xlsx,.xls,.csv" /></label>
      </div>
      <div>
        <label>Faculty Lecturers (verification)<br><input id="fileLect" type="file" accept=".xlsx,.xls,.csv" /></label>
      </div>
      <div style="align-self:center">
        <button id="btnProcess">Process & Verify</button>
      </div>
      <div style="align-self:center">
        <button id="btnExport" class="export" disabled>Export Results (CSV)</button>
      </div>
    </div>

    <div style="margin-top:12px" class="note">
      Comparison fields: <strong>Name, Department, Teaching, Research, Societal Benefits, Overall Points, Final Rating, Positivity Score</strong>.
      The tool will verify each specified sheet from the main file.
    </div>
  </div>

  <div id="summary" class="card" style="display:none">
    <div class="row">
      <div><span class="badge green" id="countMatch">0 matched</span></div>
      <div><span class="badge red" id="countMismatch">0 mismatched</span></div>
      <div class="flexright small">Total checked: <strong id="countTotal">0</strong></div>
    </div>
    <div style="margin-top:8px">
      <input id="filterInput" placeholder="Filter by KFUPM ID, name, department, or status" style="padding:8px;width:100%" />
    </div>
  </div>

  <div id="results" class="card" style="display:none;overflow:auto;max-height:56vh">
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Sheet</th>
          <th>KFUPM ID</th>
          <th>Rank</th>
          <th>Name (Main)</th>
          <th>Name (Verify)</th>
          <th>Department (Main)</th>
          <th>Department (Verify)</th>
          <th>Teaching</th>
          <th>Research</th>
          <th>Societal Benefits</th>
          <th>Overall Points</th>
          <th>Final Rating</th>
          <th>Positivity Score</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer class="footer">Designed Ï€ Hadi</footer>

<script>
(() => {
  const TARGET_SHEETS = ['All Faculty','CHM','CEP','CCM','CDB','CPG','KBS','CGS','PREP YEAR','DCC'];

  const fileMain = document.getElementById('fileMain');
  const fileProf = document.getElementById('fileProf');
  const fileLect = document.getElementById('fileLect');
  const btnProcess = document.getElementById('btnProcess');
  const resultsTableBody = document.querySelector('#resultsTable tbody');
  const summary = document.getElementById('summary');
  const countMatch = document.getElementById('countMatch');
  const countMismatch = document.getElementById('countMismatch');
  const countTotal = document.getElementById('countTotal');
  const btnExport = document.getElementById('btnExport');
  const filterInput = document.getElementById('filterInput');

  function readFileAsync(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = e => resolve(XLSX.read(e.target.result, {type:'binary'}));
      reader.onerror = reject;
      reader.readAsBinaryString(file);
    });
  }
  function sheetToJsonSafe(wb,sheetName){
    const sh = wb.Sheets[sheetName];
    if(!sh) return [];
    return XLSX.utils.sheet_to_json(sh,{defval:''});
  }
  function normalize(v){return String(v??'').trim();}
  function compare(a,b){
    const na = normalize(a).toLowerCase();
    const nb = normalize(b).toLowerCase();
    const naNum = parseFloat(na.replace(/,/g,''));
    const nbNum = parseFloat(nb.replace(/,/g,''));
    if(!isNaN(naNum) && !isNaN(nbNum)) return Math.abs(naNum-nbNum)<1e-6;
    return na===nb;
  }

  btnProcess.addEventListener('click',async()=>{
    btnProcess.disabled=true;btnProcess.textContent='Processing...';
    try{
      const [wbMain,wbProf,wbLect] = await Promise.all([
        readFileAsync(fileMain.files[0]),readFileAsync(fileProf.files[0]),readFileAsync(fileLect.files[0])
      ]);
      const profRows = sheetToJsonSafe(wbProf,wbProf.SheetNames[0]);
      const lectRows = sheetToJsonSafe(wbLect,wbLect.SheetNames[0]);
      const mapProf = new Map(profRows.map(r=>[normalize(r['KFUPM ID']||r['ID']),r]));
      const mapLect = new Map(lectRows.map(r=>[normalize(r['KFUPM ID']||r['ID']),r]));

      let matched=0,mismatched=0,total=0;
      resultsTableBody.innerHTML='';
      window._exportRows=[];

      for(const sheet of TARGET_SHEETS){
        if(!wbMain.SheetNames.includes(sheet)) continue;
        const mainRows = sheetToJsonSafe(wbMain,sheet);
        for(const mainRow of mainRows){
          total++;
          const id = normalize(mainRow['KFUPM ID']||mainRow['ID']);
          const rank = normalize(mainRow['Rank']);
          const isProf = rank.toLowerCase().includes('profess');
          const vRow = isProf ? mapProf.get(id) : mapLect.get(id);
          let rowStatus='matched';
          if(!vRow) rowStatus='mismatched';
          const fields=['Name','Department','Teaching','Research','Societal Benefits','Overall Points','Final Rating','Positivity Score'];
          for(const f of fields){
            if(!vRow || !compare(mainRow[f],vRow[f])){rowStatus='mismatched';}
          }
          if(rowStatus==='matched') matched++; else mismatched++;

          const tr=document.createElement('tr');
          tr.className=rowStatus==='matched'?'match':'mismatch';
          tr.innerHTML=`<td>${sheet}</td><td>${id}</td><td>${rank}</td><td>${mainRow['Name']||''}</td><td>${vRow?vRow['Name']||'':''}</td><td>${mainRow['Department']||''}</td><td>${vRow?vRow['Department']||'':''}</td><td>${mainRow['Teaching']||''}</td><td>${mainRow['Research']||''}</td><td>${mainRow['Societal Benefits']||''}</td><td>${mainRow['Overall Points']||''}</td><td>${mainRow['Final Rating']||''}</td><td>${mainRow['Positivity Score']||''}</td><td><span class="badge ${rowStatus==='matched'?'green':'red'}">${rowStatus==='matched'?'Matched':'Mismatch'}</span></td>`;
          resultsTableBody.appendChild(tr);

          window._exportRows.push({Sheet:sheet,'KFUPM ID':id,Rank:rank,Status:rowStatus});
        }
      }

      countTotal.textContent=total;
      countMatch.textContent=`${matched} matched`;
      countMismatch.textContent=`${mismatched} mismatched`;
      summary.style.display='';
      document.getElementById('results').style.display='';
      btnExport.disabled=false;

      filterInput.addEventListener('input',e=>{
        const q=e.target.value.toLowerCase();
        for(const tr of resultsTableBody.querySelectorAll('tr')){
          tr.style.display=tr.textContent.toLowerCase().includes(q)?'':'none';
        }
      });

    }catch(e){alert('Error: '+e.message);}finally{btnProcess.disabled=false;btnProcess.textContent='Process & Verify';}
  });

  btnExport.addEventListener('click',()=>{
    const rows=window._exportRows||[];if(!rows.length)return;
    const csv=[Object.keys(rows[0]).join(',')];
    for(const r of rows){csv.push(Object.values(r).map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(','));}
    const blob=new Blob([csv.join('\n')],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='verification_results.csv';a.click();
  });
})();
</script>
</body>
</html>
